<?xml version="1.0" encoding="UTF-8"?>

<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:osgi="http://www.springframework.org/schema/osgi"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                                 http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd">

    <beans:bean class="com.atlassian.webhooks.plugin.WebHookEventsProcessor">
        <beans:constructor-arg index="0" ref="eventPublisher"/>
        <beans:constructor-arg index="1" ref="pluginEventManager"/>
        <beans:constructor-arg index="2" ref="webHookPublisher"/>
        <beans:constructor-arg index="3" ref="webHookRegistry"/>
    </beans:bean>

    <beans:bean id="webHookRegistry" class="com.atlassian.webhooks.plugin.DelegatingWebHookRegistry">
        <beans:constructor-arg>
            <beans:list>
                <beans:bean class="com.atlassian.webhooks.plugin.OsgiWebHookProviderWebHookRegistry">
                    <beans:constructor-arg ref="waitableServiceTrackerFactory"/>
                </beans:bean>
                <beans:bean class="com.atlassian.webhooks.plugin.AnnotationWebHookRegistry" />
            </beans:list>
        </beans:constructor-arg>
    </beans:bean>

    <beans:bean id="webHookListenerProvider" class="com.atlassian.webhooks.plugin.DelegatingWebHookListenerProvider">
        <beans:constructor-arg>
            <beans:list>
                <beans:bean class="com.atlassian.webhooks.plugin.OsgiWebHookListenerProvider">
                    <beans:constructor-arg ref="waitableServiceTrackerFactory"/>
                </beans:bean>
                <beans:ref bean="moduleDescriptorWebHookRegistry" />
                <beans:bean class="com.atlassian.webhooks.plugin.PersistentWebHookListenerProvider">
                    <beans:constructor-arg index="0" ref="webHookListenerService" />
                    <beans:constructor-arg index="1" ref="osgiWebHookModelTransformer" />
                </beans:bean>
            </beans:list>
        </beans:constructor-arg>
    </beans:bean>

    <beans:bean id="webHookListenerActionValidator" class="com.atlassian.webhooks.plugin.rest.WebHookListenerActionValidatorImpl">
        <beans:constructor-arg index="0" ref="bundleContext" />
    </beans:bean>

    <beans:bean id="osgiWebHookModelTransformer" class="com.atlassian.webhooks.plugin.OsgiWebHookListenerTransformer">
        <beans:constructor-arg index="0" ref="waitableServiceTrackerFactory" />
    </beans:bean>

    <beans:bean id="moduleDescriptorWebHookRegistry" class="com.atlassian.webhooks.plugin.ModuleDescriptorWebHookListenerRegistryImpl" />

    <beans:bean id="webHookListenerStore" class="com.atlassian.webhooks.plugin.store.OsgiWebHookListenerStore">
        <beans:constructor-arg index="0" ref="bundleContext" />
    </beans:bean>

    <beans:bean id="webHookListenerCachingStore" class="com.atlassian.webhooks.plugin.store.WebHookListenerCachingStore">
        <beans:constructor-arg index="0" ref="webHookListenerStore" />
    </beans:bean>

    <beans:bean id="webHookListenerService" class="com.atlassian.webhooks.plugin.api.WebHookListenerServiceImpl">
        <beans:constructor-arg index="0" ref="webHookListenerCachingStore" />
        <beans:constructor-arg index="1" ref="webHookListenerActionValidator" />
        <beans:constructor-arg index="2" ref="webHookEventDispatcher" />
        <beans:constructor-arg index="3" ref="i18nResolver" />
    </beans:bean>

    <beans:bean id="webHookPublisher" class="com.atlassian.webhooks.plugin.WebHookPublisherImpl">
        <beans:constructor-arg index="0" ref="webHookListenerProvider"/>
        <beans:constructor-arg index="1">
            <beans:bean class="com.atlassian.webhooks.plugin.PublishTaskFactoryImpl">
                <beans:constructor-arg index="0" ref="httpClient"/>
                <beans:constructor-arg index="1" ref="requestSigner"/>
                <beans:constructor-arg index="2" ref="pluginUriResolver"/>
                <beans:constructor-arg index="3" ref="userManager"/>
                <beans:constructor-arg index="4" ref="pluginUriCustomizer" />
            </beans:bean>
        </beans:constructor-arg>
        <beans:constructor-arg index="2" ref="eventPublisher"/>
    </beans:bean>

    <beans:bean id="webHookEventDispatcher" class="com.atlassian.webhooks.plugin.event.WebHookEventDispatcher">
        <beans:constructor-arg index="0" ref="eventPublisher" />
    </beans:bean>

    <beans:bean id="requestSigner" class="com.atlassian.webhooks.plugin.impl.RequestSignerImpl">
        <beans:constructor-arg ref="bundleContext"/>
    </beans:bean>

    <beans:bean id="pluginUriResolver" class="com.atlassian.webhooks.plugin.impl.PluginUriResolverImpl">
        <beans:constructor-arg index="0" ref="applicationProperties"/>
        <beans:constructor-arg index="1" ref="bundleContext"/>
    </beans:bean>

    <beans:bean id="pluginUriCustomizer" class="com.atlassian.webhooks.plugin.impl.PluginUriCustomizerImpl">
        <beans:constructor-arg index="0" ref="bundleContext"/>
    </beans:bean>

    <beans:bean id="waitableServiceTrackerFactory" class="com.atlassian.osgi.tracker.WaitableServiceTrackerFactory">
        <beans:constructor-arg ref="bundleContext"/>
    </beans:bean>

    <!-- UI -->
    <beans:bean id="webHookUIRegistry" class="com.atlassian.webhooks.plugin.web.WebHookUIRegistry">
        <beans:constructor-arg index="0" ref="waitableServiceTrackerFactory" />
    </beans:bean>

    <osgi:service id="pluginWebHookProvider" interface="com.atlassian.webhooks.spi.provider.WebHookProvider">
        <beans:bean class="com.atlassian.webhooks.plugin.provider.PluginWebHookProvider">
            <beans:constructor-arg ref="applicationProperties"/>
        </beans:bean>
    </osgi:service>
</beans:beans>
